/*!
 * Log Colourer.js v0.0.3
 * http://aligo.github.com/log-colourer.js
 * http://ellesime.anetcity.com/ellesime/bbs/index.php?topic=38402.0
 * https://github.com/aligo/log-colourer.js
 *
 *
 * Copyright 2011, aligo, http://aligo.me/
 * Dual licensed under the MIT or GPL Version 2 licenses.
 */
(function(a,k,h){a(function(){var c=Math.round((new Date).getTime()/1E3),b=new k;a.fn.colorselecter=function(){a(this).find("[data-role=collapsible]").collapsible();a(this).find("[data-role=fieldcontain]").fieldcontain();a(this).find("select").selectmenu();a(this).find("input").textinput()};a.fn.pickcolor=function(e){a(this).find("option").eq(e).attr("selected","selected")};a("#first #log-format").change(function(){if("custom"===a(this).val())a("#first #name-regexp, #first #drop-regexp").textinput("enable");
else{a("#first #name-regexp, #first #drop-regexp").textinput("disable");a("#first #name-regexp").val(a(this).find("option:selected").data("name-regexp"));a("#first #drop-regexp").val(a(this).find("option:selected").data("drop-regexp"))}});a("a.refresh").each(function(){a(this).attr("href",a(this).attr("href")+"?"+c)});a("#first").bind("pageshow",function(){a(this).find("#log-format").trigger("change");b.init()});a("#second").bind("pagebeforeshow",function(){if(b.check()){a("#second #colourer_sets").html("");
var e=a(a("#second #color_selecter").html().replace(/{id}/g,"time").replace(/{field}/g,"\u65f6\u95f4"));a(e).find("option[value=same]").remove();a(e).pickcolor(-2);var f=a(a("#second #color_selecter").html().replace(/{id}/g,"hide").replace(/{field}/g,"\u9690\u85cf"));a(f).find("option[value=same]").remove();a(f).pickcolor(-2);a("#second #colourer_sets").append(e,f);b.regexp(a("#first #name-regexp").val(),a("#first #drop-regexp").val(),a("#first #hide-regexp").val()).parse(a("#first #log-text").val());
a.each(b.names,function(d,g){var i=a(a("#second #color_selecter").html().replace(/{id}/g,"name_"+d).replace(/{field}/g,"\u540d\u5b57"));a(i).find("option[value=same]").remove();var j=a(a("#second #color_selecter").html().replace(/{id}/g,"said_"+d).replace(/{field}/g,"\u8bf4\u8bdd")),l=a(a("#second #color_selecter").html().replace(/{id}/g,"done_"+d).replace(/{field}/g,"\u52a8\u4f5c")),n=a(a("#second #colourer_set").html().replace(/{id}/g,d).replace(/{name}/g,g));if(0===d){a(i).pickcolor(-1);a(l).pickcolor(12);
a(j).pickcolor(12)}else if(-1!==g.toLowerCase().indexOf("bot")){a(i).pickcolor(11);a(l).pickcolor(-4);a(j).pickcolor(-4)}else{var m=1+(d-1)*3%15+Math.floor((d-1)*3/15);if(m>10)m+=1;a(i).pickcolor(m)}a(n).find("p").append(i,j,l);a("#second #colourer_sets").append(n)});a("#second #colourer_sets").colorselecter();a("#second #colourer_sets select").change(function(){var d=a("#"+a(this).attr("id").replace(/color_select_\S+_/g,"color_set_")),g=a("#"+a(this).attr("id").replace(/color_select/g,"color")),
i=a(this).val();if("custom"===i)g.textinput("enable");else if("same"===i){g.textinput("disable");g.val(d.find("input").first().val()).trigger("change")}else{g.textinput("disable");g.val(i).trigger("change")}});a("#second #colourer_sets input").change(function(){var d=a(this).attr("id"),g="#"+d.replace(/color_\S+_/g,"color_set_"),i=g+" .color_"+d.split("_")[1],j=a(this).val();if("white"===j)j="#DDD";a(i).css("color",j);-1!==d.indexOf("_name_")&&a(g).find("select").each(function(){-1===a(this).attr("id").indexOf("_name_")&&
a(this).trigger("change")})})}});a("#second").bind("pageshow",function(){a(this).find("select").trigger("change")});a("#third").bind("pagebeforeshow",function(){a("#second ").find("input").each(function(){var f=a(this).attr("id").split("_");f[2]===h?b.setColourer(f[1],b.getColourerFunc(a(this).val())):b.setNameColourer(f[2],f[1],b.getColourerFunc(a(this).val()))});b.deal_time=a("#deal-time input:radio:checked").val();var e=b.output();a("#bbcode_output").val(e);e=e.replace(/</g,"&lt;").replace(/>/g,
"&gt;").replace(/\[\/color\]/g,"</span>").replace(/\[color=([^\]]+)\]/g,'<span style="color: $1;">').replace(/\n/g,"<br />\n");a("#html_output").val(e);a(".preview_output").html(e)});a(".html_output, .preview_output").hide();a("#output_navbar a").click(function(){a("#output_navbar a").removeClass("ui-btn-active");a(this).addClass("ui-btn-active");a("#outputs>div").hide();a("#outputs ."+a(this).data("output")+"_output").show()})})})(jQuery,function(a,k){String.prototype.toRegExp=function(){return RegExp(this.replace(/^~\^(.*)~S$/,
"^$1"))};var h=function(){this.init()};h.prototype.check=function(){return this.changed};h.prototype.init=function(){this.rows=[];this.names=[];this.namescolourers=[];this.colourers=[];this.output_rows=[];this.prev_color="";this.changed=true;this.deal_time="cut3";return this};h.prototype.regexp=function(c,b,e){this.name_regexp=c.toRegExp();this.drop_regexp=b.toRegExp();this.hide_regexp=e.toRegExp();this.cut2_regexp=/^.*?(\d{2}:\d{2})(?::\d{2})?.*?$/;this.cut3_regexp=/^.*?(\d{2}:\d{2}:\d{2}).*?$/;
return this};h.prototype.parse=function(c){var b=this;c=c.replace(/(?:\x0f|\x1f|\x02|\x03)(?:\d{1,2}(?:,\d{1,2})?)?/g,"");a.each(c.split("\n"),function(e,f){if(false===b.drop_regexp.test(f)){var d=b.name_regexp.exec(f);if(null!==d){var g=(d[2]||d[3]||d[4]).split("|")[0];-1===b.names.indexOf(g)&&b.names.push(g);var i=d[3]!==""?"done":"said",j=f.replace(d[0],"");if(b.hide_regexp.test(j))i="hide";b.output_rows.push([g,i,d[1],d[0].replace(d[1],""),j])}}});this.changed=false;return this};h.prototype.names=
function(){return this.names};h.prototype.getColourerFunc=function(c){return function(b,e){var f="";if(e!==c){if(""!==e)f="[/color]";if(""!==c)b="[color="+c+"]"+b}return[f+b,c]}};h.prototype.setColourer=function(c,b){this.colourers[c]=b;return this};h.prototype.setNameColourer=function(c,b,e){if(k===this.namescolourers[c])this.namescolourers[c]=[];this.namescolourers[c][b]=e;return this};h.prototype.callNameColourer=function(c,b,e){c="hide"===b||"time"===b?this.colourers[b]:this.namescolourers[c][b];
if(k!==c){c=c(e,this.prev_color);e=c[0];this.prev_color=c[1]}return e};h.prototype.dealWithTime=function(c){if("cut3"===this.deal_time||"cut2"===this.deal_time){var b=this[this.deal_time+"_regexp"].exec(c);if(null!==b)c=b[1]||c}else if("drop"===this.deal_time)return"";return this.callNameColourer(0,"time",c)};h.prototype.output=function(){var c="",b=this;a.each(this.output_rows,function(e,f){var d=b.names.indexOf(f[0]);c=c+b.dealWithTime(f[2])+b.callNameColourer(d,"name",f[3])+b.callNameColourer(d,
f[1],f[4])+"\n"});if(""!==this.prev_color)c+="[/color]";return c.replace(/\n\[\/color\]/g,"[/color]\n")};return h}(jQuery));
